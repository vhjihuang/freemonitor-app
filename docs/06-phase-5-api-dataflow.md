# 阶段五：API 与数据流 [90%]

## API 客户端 🟡

### ✅ 完善 API 请求封装

**状态**: 已完成

**描述**: 封装 HTTP 请求方法

**实现逻辑**: 统一请求头 → 提供拦截和响应处理

**相关文件**: apps/frontend/src/lib/api.ts

**验收标准**: API 调用简洁，请求头一致

### ☐ 添加请求重试机制

**状态**: 未开始

**描述**: 自动重试失败请求

**实现逻辑**: 使用指数退避算法 → 限制重试次数

**相关文件**: apps/frontend/src/lib/api.ts

**验收标准**:
- 重试策略：指数退避算法，首次1秒，最大30秒，重试次数3次
- 重试条件：网络错误、5xx服务器错误、429限流错误，不重试4xx客户端错误
- 错误分类：网络超时、服务器错误、认证失败、限流，每种类型不同处理方式
- 用户提示：重试时显示"连接中..."状态，失败后显示具体错误信息和重试按钮
- 取消机制：支持用户主动取消重试，避免无限重试循环
- 日志记录：记录每次重试的时间、错误码、响应时间，支持调试模式查看
- 智能退避：根据错误类型调整退避时间，429错误按Retry-After头等待

### ✅ 实现错误统一处理

**状态**: 已完成

**描述**: 统一处理 API 错误

**实现逻辑**: 捕获错误 → 格式化信息 → 记录日志

**相关文件**: apps/frontend/src/lib/api.ts

**验收标准**: 错误信息统一，日志记录完整

### ✅ 添加请求取消功能

**状态**: 已完成

**描述**: 支持取消正在进行的请求

**实现逻辑**: 提供取消令牌 → 处理资源清理

**相关文件**: apps/frontend/src/lib/api.ts

**验收标准**:
- 取消令牌：基于AbortController实现，支持请求级别的细粒度取消
- 取消场景：组件卸载、用户主动取消、页面跳转、重复请求自动取消前一个
- 内存清理：请求取消后自动清理相关引用、事件监听器、定时器
- 错误处理：取消的请求不触发错误提示，返回特定的取消错误类型
- 并发控制：同一API的并发请求自动取消旧请求，避免竞态条件
- 调试支持：开发模式下在控制台显示被取消的请求信息
- 性能监控：监控取消请求的内存占用，确保取消后内存立即释放

### ✅ 优化 TypeScript 类型

**状态**: 已完成

**描述**: 为 API 定义类型

**实现逻辑**: 定义请求和响应类型 → 减少运行时错误

**相关文件**: apps/frontend/src/lib/api.ts

**验收标准**: 类型安全，编译无错误

## 状态管理 🟡

### ✅ 完善 useAuth hook

**状态**: 已完成

**描述**: 管理用户认证状态

**实现逻辑**: 提供登录/登出 → 处理令牌存储和刷新

**相关文件**: apps/frontend/src/hooks

**验收标准**: 认证状态正确管理，方法正常

### ✅ 实现 useDevices hook

**状态**: 已完成

**描述**: 管理设备数据状态

**实现逻辑**: 提供数据获取和操作方法

**相关文件**: apps/frontend/src/hooks

**验收标准**: 设备数据正确更新，操作正常

### ✅ 创建 useAlerts hook

**状态**: 已完成

**描述**: 管理告警数据状态

**实现逻辑**: 提供告警数据获取和操作方法

**相关文件**: apps/frontend/src/hooks

**验收标准**: 告警数据正确管理，操作正常

### ✅ 添加 useMetrics hook

**状态**: 已完成

**描述**: 管理指标数据状态

**实现逻辑**: 提供数据获取和订阅方法 → 优化缓存

**相关文件**: 
- apps/frontend/src/hooks/useMetrics.ts
- apps/frontend/src/components/dashboard/RealtimeDataChart.tsx
- apps/frontend/src/components/examples/MetricsChartExample.tsx

**验收标准**:
- 实时更新：WebSocket连接，数据延迟 < 1秒，断线自动重连
- 缓存策略：本地内存缓存+IndexedDB持久化，缓存有效期5分钟
- 数据同步：后台数据更新时，前端缓存自动失效并重新获取
- 性能优化：增量更新只传输变化数据，减少带宽占用90%
- 分页缓存：支持分页数据的独立缓存，翻页时优先使用缓存
- 内存管理：缓存大小限制100MB，超出时LRU算法清理旧数据
- 离线支持：网络断开时显示最后缓存数据，重连后自动同步

**实际实现**:
- ✅ **React Query集成**: 使用 `useQuery` 实现数据获取和缓存
- ✅ **智能缓存策略**: 默认5分钟缓存，支持自定义 `staleTime`
- ✅ **重试机制**: 最多3次重试，使用指数退避策略
- ✅ **参数化查询**: 支持设备ID、时间范围、分页等参数
- ✅ **错误处理**: 完善的错误状态管理
- ✅ **实际应用**: 已在实时数据图表和示例组件中使用

### ☐ 实现数据缓存策略

**状态**: 未开始

**描述**: 优化数据获取性能

**实现逻辑**: 设计缓存机制 → 处理更新和失效

**相关文件**: apps/frontend/src/hooks

**验收标准**:
- 缓存层级：L1内存缓存(50ms)、L2 IndexedDB缓存(100ms)、L3网络请求(500ms)
- 缓存命中率：静态资源>95%，API数据>80%，用户会话数据>90%
- 缓存失效：基于时间(TTL)、事件驱动、手动失效三种策略
- 性能提升：缓存命中时响应时间减少80%，整体页面加载时间减少60%
- 缓存监控：提供缓存命中率、失效率、清理频率的实时监控
- 缓存一致性：采用最终一致性模型，最大延迟容忍30秒
- 缓存预热：关键页面数据预加载，用户访问前提前缓存