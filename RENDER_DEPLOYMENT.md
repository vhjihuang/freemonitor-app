# Render 部署指南

## 部署配置总结

基于你的本地配置，以下是Render部署的完整设置：

### 后端服务 (Web Service)

**Build Command:**
```bash
cd apps/backend && pnpm run render:build
```

**Start Command:**
```bash
cd apps/backend && pnpm run render:start
```

**Environment Variables:**
```
NODE_ENV=production
PORT=10000
API_PREFIX=api
JWT_SECRET=[Auto-generated by Render]
DATABASE_URL=[From PostgreSQL database]
CORS_ORIGIN=https://your-frontend-domain.vercel.app,http://localhost:3000
RENDER_SEED=true
```

### 前端服务 (Static Site)

**Build Command:**
```bash
cd apps/frontend && npm install && RENDER_STATIC=true npm run build
```

**Publish Directory:**
```
apps/frontend/out
```

**Environment Variables:**
```
NEXT_PUBLIC_API_URL=https://your-backend-service.onrender.com
RENDER_STATIC=true
```

### 数据库 (PostgreSQL)

- **Name:** freemonitor-db
- **Database Name:** freemonitor
- **User:** freemonitor_user
- **Plan:** Free

## 部署步骤

### 1. 创建PostgreSQL数据库
1. 在Render Dashboard中创建新的PostgreSQL数据库
2. 记录连接字符串

### 2. 部署后端服务
1. 创建新的Web Service
2. 连接你的GitHub仓库
3. 设置上述的Build和Start命令
4. 配置环境变量
5. 部署

### 3. 部署前端服务
1. 创建新的Static Site
2. 连接同一个GitHub仓库
3. 设置Build命令和发布目录
4. 配置环境变量（使用后端服务的URL）
5. 部署

## 自动化脚本说明

### 后端脚本
- `render:build`: 安装依赖 → 生成Prisma客户端 → 构建应用
- `render:start`: 运行数据库迁移 → 启动应用

### 数据库迁移
- 每次启动时自动运行 `prisma migrate deploy`
- 如果设置了 `RENDER_SEED=true`，会运行种子数据

### 健康检查
- 端点: `/api/health`
- 检查数据库连接和应用状态

## 注意事项

1. **首次部署**: 可能需要等待数据库迁移完成
2. **种子数据**: 设置 `RENDER_SEED=true` 来创建测试数据
3. **CORS配置**: 确保前端域名在CORS_ORIGIN中
4. **环境变量**: JWT_SECRET让Render自动生成
5. **监控**: 使用 `/api/health` 端点监控服务状态

## 验证部署

部署完成后，访问以下端点验证：
- `https://your-backend.onrender.com/api/health` - 健康检查
- `https://your-backend.onrender.com/api/dashboard/stats` - 需要认证
- `https://your-frontend.onrender.com` - 前端应用

## 故障排除

### 常见问题

#### 1. 数据库字段不匹配错误
如果看到 `The column users.passwordResetToken does not exist` 错误：

**解决方案A：手动执行SQL**
1. 登录Render Dashboard
2. 进入PostgreSQL数据库管理界面
3. 执行 `fix-render-db.sql` 中的SQL语句

**解决方案B：重新部署触发迁移**
1. 推送一个小的代码更改
2. 触发重新部署
3. 迁移脚本会自动执行

#### 2. 其他问题
如果遇到其他问题：
1. 检查Render的部署日志
2. 验证环境变量设置
3. 确认数据库连接字符串
4. 检查CORS配置是否包含前端域名

### 自动修复机制

应用现在会在启动时自动检查和修复数据库字段：

1. **自动修复**: 生产环境启动时自动添加缺失字段
2. **健康检查**: 访问 `/api/health/db-fields` 检查字段状态
3. **管理页面**: 访问 `/admin` 页面进行系统诊断

### 手动修复SQL（备用方案）
```sql
-- 添加缺失的密码重置字段
ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "passwordResetToken" TEXT;
ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "passwordResetExpiresAt" TIMESTAMP(3);

-- 添加唯一约束
ALTER TABLE "users" ADD CONSTRAINT "users_passwordResetToken_key" UNIQUE ("passwordResetToken");
```

### 验证修复
```bash
# 检查应用健康状态
curl https://your-app.onrender.com/api/health

# 检查数据库字段
curl https://your-app.onrender.com/api/health/db-fields
```